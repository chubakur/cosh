#!/usr/bin/python
import os, sys
from subprocess import Popen
from utils import optfunc
from os.path import abspath, dirname
from datetime import datetime

def vprint(s, verbose):
    if verbose:
        print
        print s

def call(cmd, verbose=False, allow_fail=False):
    if verbose:
        print cmd
    p = Popen(cmd, shell=True)
    p.communicate()
    status = p.returncode
    if status != 0 and not allow_fail:
        print "command failed:\n%s" % cmd
        exit()
    else:
        return status

TEMPLATE = """#!r6rs

(import (rnrs)
        (scheme-tools)
        (cosh))

(define expr
  '(
%(code)s

))

(define marginal->value car)
(define marginal->log-prob cdr)
(let ([marginals (cosh expr %(cosh-params)s)])
  (for-each (lambda (marginal)
       (pe (marginal->value marginal) ": "
           (exp (marginal->log-prob marginal))
           " (" (marginal->log-prob marginal) ")\n"))
     marginals)
  (when %(verbose)s
    (pe "\nsum: " (exp (apply logsumexp (map marginal->log-prob marginals))) "\n")))
"""

def val_string(obj):
    if type(obj) == str and obj.isdigit():
        return int(obj)
    elif obj:
        return "#t"
    else:
        return "#f"

def param_string(params):
    s = ""
    for (key, val) in params.items():
        s += " '%s %s " % (key, val_string(val))
    return s

@optfunc.main
@optfunc.arghelp('limit', 'restrict graph size')
@optfunc.arghelp('verbose', 'display all executed commands')
@optfunc.arghelp('debug', 'run all scheme commands in debug mode')
@optfunc.arghelp('time', 'record runtime')
@optfunc.arghelp('keep', 'do not delete compiled file')
def main(file, limit="", verbose=False, debug=False, time=False, keep=False):
    """Usage: %prog <file> [options]"""
    in_path = abspath(file)
    settings = {
        "debug" : debug and "--debug" or "",
        "out_path" : in_path + ".tmp",
        "cosh_path" : abspath(dirname(sys.argv[0]))
    }
    
    vprint("generating scheme code", verbose)
    code = open(in_path).read()

    params = {
        "limit" : limit,
        "verbosity" : verbose
        }
    
    generated = TEMPLATE % { "code" : code,
                             "cosh-params" : param_string(params),
                             "verbose" : val_string(verbose)}
    f = open(settings["out_path"], "w")
    f.write(generated)
    f.close()

    vprint("running generated scheme with ikarus\n", verbose)
    pre = datetime.now()
    call("export IKARUS_LIBRARY_PATH=%(cosh_path)s:$IKARUS_LIBRARY_PATH && ikarus %(debug)s --r6rs-script '%(out_path)s'\n" % settings, verbose)
    post = datetime.now()    

    if time:
        delta = post-pre
        seconds = delta.seconds + delta.microseconds/1000000.0
        print("runtime: %fs" % seconds)

    if not keep:
        vprint("removing compiled file", verbose)
        call("rm -f '%(out_path)s'" % settings, verbose)        
    
